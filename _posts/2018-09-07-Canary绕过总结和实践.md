---
title: Canary绕过总结和实践
date: 2018-09-07 10:14
tags:
- CTF
- Bin
- Reverse
categories: CTF
description: 总结学习的二进制程序保护机制Canary的绕过，并给予实践
---

为什么要研究二进制？？WEB没有生存空间呀，有一段时间感觉题目全是二进制的，以至于有个CTFer的衬衫都吐槽了这件事。除此之外，研究二进制的一个很重要的乐趣在于感受大佬们清新独特的脑回路，很多对抗保护的思路都会让你大吃一惊。

[论canary的几种玩法 ](https://veritas501.space/2017/04/28/%E8%AE%BAcanary%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8E%A9%E6%B3%95/)这篇文章在对Canary原理和常见的一些绕过方法原理总结的特别详细，本文在此文的基础上实践了各类Canary绕过的示例，算是对原文的补充。

### 绕过canary - 格式化字符串

这部分作者给出的示例，我们首先使用如下命令编译：

```shell
gcc source.c -m32 -o canary
```

如果你是在64位平台需要先按照32的库：

```shell
sudo apt-get install libc6 libc6-dev
```

使用checksec查看canary程序的保护机制：

![1536297594228](D:\需要备份的\saferman.github.io\assets\img\canary\checksec.png)

作者给出的利用方法是：在第一次scanf的时候输入“%7$x”打印出canary，在fun中利用栈溢出控制eip跳转到getflag。 但是**为什么是"%7$x"**作者并没有给出说明，以及如何找打**EIP的位置**也没有说明，这二点对于一个初学者来讲时很困惑的，下面我将详细讲解这二个要点。

首先，先补充一个知识点，%x是格式化字符告诉printf要以16进制格式打印字符，而使用%n$x表示打印printf的格式字符串后面第n个参数的十六进制。根据调用约定（以为是C/C++程序），参数压栈方式右到左，函数外平衡堆栈，call后面跟着add esp,xxx。本示例存在printf格式化漏洞，所以我们需要从栈中寻找canary是第几个参数，以便确定n取多少。

我们使用IDA查看main函数的汇编代码如下：

![1536297884159](D:\需要备份的\saferman.github.io\assets\img\canary\main-1.png)

![1536297995302](D:\需要备份的\saferman.github.io\assets\img\canary\main-2.png)

上图红色的部分就是验证canary的汇编代码，从红线的一行可以知道main函数的cannary放在ebp+var_C地址指向的位置。

然后我们查看call _printf地址，是0x08048767。我们gdb动态调试canary程序，并设置断点停在call _printf之前:

![1536298811288](D:\需要备份的\saferman.github.io\assets\img\canary\gdb-command.png)

按照上图运行GDB命令，得到：

![1536298896554](D:\需要备份的\saferman.github.io\assets\img\canary\gdb-printf.png)

从前面的分析可以知道[ebp+var_C]就是canary，因此计算得到0xfffcf2c地址存放的就是canary，这次运行的canary是0xed4bbc00。从stack数一下（第一个是入栈作为printf格式化字符串参数）canary是第七个参数。

当然确定canary也可以从源码分析出来：

![1536299147077](D:\需要备份的\saferman.github.io\assets\img\canary\main-source.png)

canary在缓冲区下面（栈底方向），这里有char数组占6个，init()、scanf()都堆栈平衡，printf调用的时候，参数入栈，所以canary也在格式胡字符串之后的第七个参数位置。

因此在scanf("%6s",buffer)输入的时候需要输入%7$x泄露canary！

fun()函数的EIP位置在call fun的时候会入栈，因此只需要设置断点在call fun前观察栈顶的地址，下一个入栈的就是EIP。当然更进一步的验证如下：

![1536300569344](D:\需要备份的\saferman.github.io\assets\img\canary\call-fun.png)

在调用call fun前的stack情况，使用si步入进fun

![1536300650148](D:\需要备份的\saferman.github.io\assets\img\canary\fun-step-in.png)

0xffffcf1c地址存放的就是EIP。

